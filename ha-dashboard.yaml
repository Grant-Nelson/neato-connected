button_card_templates:
  neato_base:
    variables:
      .device: espcam_test_sensor
      alert_color: '#edb926'
      error_color: '#950606'
      battery_level: >-
        [[[ return
        states[`sensor.${variables[".device"]}_fuel_percent_2`]?.state; ]]]
      charging: >-
        [[[ return
        states[`binary_sensor.${variables[".device"]}_charging_active`]?.state
        === "on"; ]]]
      alert_id: '[[[ return `sensor.${variables[".device"]}_robot_alert`; ]]]'
      _alert: '[[[  return states[variables.alert_id]?.state;  ]]]'
      error_id: '[[[ return `sensor.${variables[".device"]}_robot_error`; ]]]'
      ui_state_id: '[[[ return `sensor.${variables[".device"]}_ui_state`; ]]]'
views:
  - title: Home
    sections:
      - type: grid
        cards:
          - type: vertical-stack
            cards:
              - type: custom:button-card
                template: neato_base
                icon: mdi:robot-vacuum-variant
                entity: '[[[  return variables.error_id  ]]]'
                size: 50%
                color_type: icon
                tap_action:
                  action: none
                hold_action:
                  action: none
                double_tap_action:
                  action: none
                name: |
                  [[[
                    const uiState = states['sensor.espcam_test_sensor_ui_state']?.state;
                    if (uiState.includes('STATE_IDLE')) return "IDLE";
                    else if (uiState.includes('STATE_STANDBY')) return "STANDBY";
                    else if (uiState.includes('STATE_HOUSECLEANINGPAUSED')) return "House Cleaning Paused";
                    else if (uiState.includes('STATE_HOUSECLEANINGRUNNING')) return "Cleaning House";
                    else if (uiState.includes('STATE_STARTHOUSECLEANING')) return "Starting House Cleaning";
                    else return uiState
                  ]]]
                styles:
                  icon:
                    - color: |
                        [[[
                            if (!entity.state.startsWith('200')) return variables.error_color;
                            else if (!states[variables.alert_id]?.state?.startsWith('200')) return variables.alert_color;
                        ]]]
                  card:
                    - border-radius: 20px
                    - display: flex
                    - justify-content: center
                    - align-items: center
                    - margin: 0 auto
                    - position: relative
                  custom_fields:
                    battery:
                      - position: absolute
                      - top: 8px
                      - right: 8px
                      - padding: 4px 8px
                      - border-radius: 8px
                      - font-weight: bold
                      - animation: |
                          [[[ 
                            return states['binary_sensor.espcam_test_sensor_charging_active']?.state === "on" ? 'pulseGreen 3s infinite' : ''
                          ]]]
                      - background-color: |
                          [[[
                            console.log(variables)
                            if (Number(variables.battery_level) > 35) return 'green';
                            else return '#FFBF00'
                          ]]]
                    dock:
                      - position: absolute
                      - top: 8px
                      - left: 8px
                      - padding: 4px
                      - border-radius: 8px
                      - background-color: rgba(255,255,255,0.2)
                      - display: |
                          [[[
                            return states['binary_sensor.espcam_test_sensor_ext_power_present']?.state === "on"
                              ? "block"
                              : "none";
                          ]]]
                custom_fields:
                  battery: '[[[ return variables.battery_level + ''%'' ]]]'
                  dock: |
                    [[[
                      // Show an icon if docked
                      if (states['binary_sensor.espcam_test_sensor_ext_power_present']?.state === 'on') {
                        return 'DOCKED';
                      } else {
                        return 'sdfsdf';
                      }
                    ]]]
                extra_styles: |
                  @keyframes pulseGreen {
                      0% {
                        box-shadow: 0 0 5px 0 rgba(0,255,0,0.6);
                      }
                      50% {
                        box-shadow: 0 0 20px 6px rgba(0,255,0,1);
                      }
                      100% {
                        box-shadow: 0 0 5px 0 rgba(0,255,0,0.6);
                      }
                  }
              - type: vertical-stack
                cards:
                  - type: horizontal-stack
                    cards:
                      - type: custom:button-card
                        template: neato_base
                        show_icon: false
                        entity: '[[[  return variables.alert_id  ]]]'
                        show_state: false
                        styles:
                          card:
                            - border-color: |
                                [[[
                                  if (entity.state.startsWith('200')) return ""
                                  else return variables.alert_color
                                ]]]
                        name: |
                          [[[
                            if (entity.state.startsWith('200')) return "No alerts";
                            // If it does not match this regex perfectly, then return as it is
                            try { return entity.state.match(/\(UI_(ERROR|ALERT)_(.+)\)/)[2].replaceAll('_', ' ') }
                            catch { return entity.state }
                          ]]]
                      - type: custom:button-card
                        template: neato_base
                        show_icon: false
                        entity: '[[[  return variables.error_id  ]]]'
                        show_state: false
                        styles:
                          card:
                            - border-color: |
                                [[[
                                  if (entity.state.startsWith('200')) return ""
                                  else return variables.error_color
                                ]]]
                        name: |
                          [[[
                            if (entity.state.startsWith('200')) return "No errors";
                            // If it does not match this regex perfectly, then return as it is
                            try { return entity.state.match(/\(UI_(ERROR|ALERT)_(.+)\)/)[2].replaceAll('_', ' ') }
                            catch { return entity.state }
                          ]]]
              - type: horizontal-stack
                cards:
                  - type: custom:button-card
                    template: neato_base
                    entity: >-
                      [[[  return `button.${variables[".device"]}_house_clean` 
                      ]]]
                    name: Clean
                    tap_action:
                      action: toggle
                  - type: custom:button-card
                    template: neato_base
                    entity: >-
                      [[[  return `button.${variables[".device"]}_spot_clean` 
                      ]]]
                    name: Clean
                    tap_action:
                      action: toggle
                  - type: custom:button-card
                    template: neato_base
                    entity: >-
                      [[[  return
                      `button.${variables[".device"]}_stop_cleaning`  ]]]
                    name: STOP
                    tap_action:
                      action: toggle
                  - type: custom:button-card
                    template: neato_base
                    entity: >-
                      [[[  return `button.${variables[".device"]}_locate_robot` 
                      ]]]
                    name: Locate
                    tap_action:
                      action: toggle
                  - type: custom:button-card
                    name: Settings
                    icon: mdi:cog
                    tap_action:
                      action: fire-dom-event
                      browser_mod:
                        service: browser_mod.popup
                        data:
                          title: More options
                          size: normal
                          content:
                            type: vertical-stack
                            cards:
                              - type: horizontal-stack
                                cards:
                                  - show_name: true
                                    show_icon: true
                                    entity: switch.espcam_test_sensor_eco_mode
                                    name: ECO Mode
                                    type: button
                                  - show_name: true
                                    show_icon: true
                                    entity: switch.espcam_test_sensor_test_mode
                                    name: Test Mode
                                    type: button
                                  - entity: button.espcam_test_sensor_update_status
                                    name: Fetch status
                                    show_icon: true
                                    type: button
                                    tap_action:
                                      action: toggle
                                  - entity: >-
                                      binary_sensor.espcam_test_sensor_usb_connected
                                    name: USB
                                    show_icon: true
                                    type: button
                              - type: entities
                                entities:
                                  - entity: switch.espcam_test_sensor_intenseclean
                                    name: Intense Clean
                                  - entity: switch.espcam_test_sensor_led
                                    name: LED
                                  - entity: switch.espcam_test_sensor_wifi
                                    name: WiFi
                                  - entity: switch.espcam_test_sensor_melody_sounds
                                    name: Melody Sounds
                                  - entity: switch.espcam_test_sensor_warning_sounds
                                    name: Warning Sounds
                                  - entity: switch.espcam_test_sensor_click_sounds
                                    name: Click Sounds
                                  - entity: switch.espcam_test_sensor_bin_full_detect
                                    name: Bin Full Detect
                                  - entity: switch.espcam_test_sensor_schedule
                                    name: Schedule
                                state_color: false
                                show_header_toggle: false
                              - type: entities
                                entities:
                                  - entity: sensor.espcam_test_sensor_model
                                    name: Model
                                  - entity: sensor.espcam_test_sensor_serial_number
                                    name: S/N
                                  - entity: sensor.espcam_test_sensor_time_local
                                    name: Robot Time
                                  - entity: >-
                                      sensor.espcam_test_sensor_battery_voltage_v
                                    name: Battery Voltage
                                  - entity: >-
                                      sensor.espcam_test_sensor_battery_temp_c_avg
                                    name: Battery Temp (avg)
                                  - entity: sensor.espcam_test_sensor_charger_mah
                                    name: Charging
                                  - entity: sensor.espcam_test_sensor_discharge_mah
                                    name: Discharging
                              - type: horizontal-stack
                                cards:
                                  - show_name: true
                                    show_icon: true
                                    entity: button.espcam_test_sensor_shutdown
                                    type: button
                                    name: Power Off
                                    tap_action:
                                      action: toggle
                                  - show_name: true
                                    show_icon: true
                                    entity: button.espcam_test_sensor_powercycle
                                    name: Reboot Robot
                                    type: button
                                    tap_action:
                                      action: toggle
                                  - show_name: true
                                    show_icon: true
                                    type: button
                                    entity: button.espcam_test_sensor_reboot_esp
                                    name: Reboot ESP
                                    tap_action:
                                      action: toggle
    type: sections
    cards: []
